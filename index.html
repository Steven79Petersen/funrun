<!DOCTYPE html>
<html lang="en">
<head>
    <title>fun-run</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #222;
            overflow: hidden;
            touch-action: manipulation;
        }
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            margin: 0 auto;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.7);
            color: white;
            font-family: Arial;
            font-size: 24px;
            text-align: center;
            z-index: 100;
        }
        #start-btn {
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #start-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>Game is ready</div>
        <button id="start-btn">CLICK TO START</button>
        <div id="status" style="margin-top: 20px; font-size: 16px;"></div>
    </div>
    <canvas id="canvas"></canvas>

    <!-- Pygbag Loader mit expliziter Konfiguration -->
    <script src="https://pygame-web.github.io/archives/0.9/pythons.js" 
            type="module"
            data-python="python3.11"
            data-os="vtx,fs,snd,gui"></script>

    <script>
    // Zustandsvariablen
    let pygameReady = false;
    let audioUnlocked = false;
    let gameStarted = false;

    // Pygame Initialisierung überwachen
    function checkPygame() {
        if(window.pygame && !pygameReady) {
            pygameReady = true;
            console.log("Pygame initialized");
            document.getElementById('status').textContent = "Engine ready";
            tryStartGame();
        }
    }

    // Audio-Interaktion erzwingen
    function unlockAudio() {
        if(audioUnlocked) return;
        
        // Erstelle unsichtbaren Audio-Kontext
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const emptyBuffer = audioContext.createBuffer(1, 1, 22050);
        const source = audioContext.createBufferSource();
        source.buffer = emptyBuffer;
        source.connect(audioContext.destination);
        
        // Kurzer Ton abspielen (stumm)
        source.start(0);
        source.onended = () => {
            audioContext.close();
            audioUnlocked = true;
            console.log("Audio unlocked");
            document.getElementById('status').textContent = "Audio ready";
            tryStartGame();
        };
    }

    // Spielstart versuchen
    function tryStartGame() {
        if(gameStarted || !pygameReady || !audioUnlocked) return;
        gameStarted = true;
        
        document.getElementById('status').textContent = "Starting game...";
        startGame();
    }

    // Hauptspielstart
    async function startGame() {
        try {
            // Canvas einrichten
            const canvas = document.getElementById('canvas');
            canvas.width = 800;
            canvas.height = 600;
            
            // Spiel laden
            document.getElementById('status').textContent = "Loading game...";
            await window.pygame.import("./assets/main.py");
            
            // Ladebildschirm ausblenden
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 500);
            
        } catch (error) {
            console.error("Game error:", error);
            document.getElementById('status').textContent = `Error: ${error.message}`;
        }
    }

    // Startbutton Event
    document.getElementById('start-btn').addEventListener('click', () => {
        unlockAudio();
    });

    // Auch Klick auf Canvas erlauben
    document.getElementById('canvas').addEventListener('click', unlockAudio);

    // Regelmäßig auf Pygame-Initialisierung prüfen
    const pygameCheckInterval = setInterval(checkPygame, 200);
    
    // Initialisierung beenden wenn Pygame bereit
    window.addEventListener('pygame-ready', () => {
        clearInterval(pygameCheckInterval);
        checkPygame();
    });
    </script>
</body>
</html>