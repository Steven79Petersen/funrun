<!DOCTYPE html>
<html lang="de">
<head>
    <title>Fun Run Game</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            overflow: hidden;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            margin: 0 auto;
            background: #000;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        #loading-overlay h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { 
                filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            }
            to { 
                filter: drop-shadow(0 0 20px rgba(255,255,255,0.6));
            }
        }
        
        #start-button {
            padding: 15px 30px;
            font-size: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        #start-button:active {
            transform: translateY(0);
        }
        
        #status-message {
            margin-top: 20px;
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            max-width: 80%;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #error-message {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }
        
        #debug-info {
            background: rgba(0,0,0,0.3);
            color: #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: left;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .error-button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .error-button:hover {
            background: #cc3333;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h1>üèÉ‚Äç‚ôÇÔ∏è FUN RUN</h1>
        <div class="loading-spinner"></div>
        <div id="status-message">Initializing pygame-web...</div>
        <button id="start-button" style="display: none;">üöÄ START GAME</button>
        <div id="error-message" style="display: none;"></div>
        <div id="debug-info" style="display: none;"></div>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        // Configuration
        var CONFIG = {
            PYGAME_SOURCES: [
                'https://pygame-web.github.io/archives/0.21/pythons.js',
                './assets/pythons.js',
                'https://pypi.org/project/Python.js/'
            ],
            PYTHON_VERSION: 'python3.11',
            REPO_URL: 'https://pygame-web.github.io/repo/',
            LOAD_TIMEOUT: 85000
        };

        // Game state
        var GameState = {
            pygameReady: false,
            userInteracted: false,
            gameStarted: false,
            debug: []
        };

        // DOM elements
        var elements = {
            overlay: document.getElementById('loading-overlay'),
            canvas: document.getElementById('canvas'),
            startButton: document.getElementById('start-button'),
            statusMessage: document.getElementById('status-message'),
            errorMessage: document.getElementById('error-message'),
            debugInfo: document.getElementById('debug-info')
        };

        // Debug logging
        function debugLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            var logMessage = '[' + timestamp + '] ' + message;
            GameState.debug.push(logMessage);
            console.log(logMessage);
            
            if (GameState.debug.length > 20) {
                GameState.debug.shift();
            }
        }

        function updateStatus(message) {
            elements.statusMessage.textContent = message;
            debugLog('Status: ' + message);
        }

        function showDebug() {
            elements.debugInfo.textContent = GameState.debug.join('\n');
            elements.debugInfo.style.display = 'block';
        }

        function showError(message) {
            var safeMessage = String(message).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var errorHtml = '<div>' + safeMessage + '</div>';
            errorHtml += '<div style="margin-top: 10px; font-size: 12px;">';
            errorHtml += '<button class="error-button" onclick="window.showDebug()">Show Debug Info</button>';
            errorHtml += '<button class="error-button" onclick="location.reload()">Refresh Page</button>';
            errorHtml += '</div>';
            
            elements.errorMessage.innerHTML = errorHtml;
            elements.errorMessage.style.display = 'block';
            elements.startButton.style.display = 'none';
            debugLog('Error: ' + message);
        }

        // Pygame-web initialization
        function loadPygameWeb() {
            return new Promise(function(resolve, reject) {
                // Remove any existing scripts
                var existingScripts = document.querySelectorAll('script[src*="pythons.js"]');
                for (var i = 0; i < existingScripts.length; i++) {
                    existingScripts[i].remove();
                }
                
                var sourceIndex = 0;
                
                function tryNextSource() {
                    if (sourceIndex >= CONFIG.PYGAME_SOURCES.length) {
                        var errorMsg = 'Failed to load pygame-web from all sources. Please try:\n1. Refreshing the page\n2. Using Chrome/Edge browser\n3. Checking your network connection';
                        showError(errorMsg);
                        resolve(false);
                        return;
                    }
                    
                    var source = CONFIG.PYGAME_SOURCES[sourceIndex];
                    
                    try {
                        updateStatus('Loading from ' + new URL(source).hostname + '...');
                        debugLog('Trying source: ' + source);
                        
                        var script = document.createElement('script');
                        script.src = source;
                        script.type = 'module';
                        script.setAttribute('data-python', CONFIG.PYTHON_VERSION);
                        script.setAttribute('data-os', 'vtx,fs,snd,gui');
                        script.setAttribute('data-repo', CONFIG.REPO_URL);
                        
                        script.onload = function() {
                            window.pygameConfig = {
                                stdio: 'inherit',
                                python: CONFIG.PYTHON_VERSION,
                                env: { PYTHONPATH: '/lib/python3.11' }
                            };
                            
                            // Check for initialization
                            var checkCount = 0;
                            var check = setInterval(function() {
                                checkCount++;
                                if (window.pygame && typeof window.pygame.import === 'function') {
                                    clearInterval(check);
                                    debugLog('Successfully loaded from ' + source);
                                    resolve(true);
                                } else if (checkCount > CONFIG.LOAD_TIMEOUT / 500) {
                                    clearInterval(check);
                                    debugLog('Timeout loading from ' + source);
                                    sourceIndex++;
                                    tryNextSource();
                                }
                            }, 500);
                        };
                        
                        script.onerror = function() {
                            debugLog('Failed with source ' + source + ': Script error');
                            var failedScripts = document.querySelectorAll('script[src="' + source + '"]');
                            for (var i = 0; i < failedScripts.length; i++) {
                                failedScripts[i].remove();
                            }
                            sourceIndex++;
                            tryNextSource();
                        };
                        
                        document.head.appendChild(script);
                        
                    } catch (error) {
                        debugLog('Failed with source ' + source + ': ' + error.message);
                        sourceIndex++;
                        tryNextSource();
                    }
                }
                
                tryNextSource();
            });
        }

        // Audio initialization
        function initializeAudio() {
            try {
                if (window.AudioContext || window.webkitAudioContext) {
                    new (window.AudioContext || window.webkitAudioContext)();
                    debugLog("Audio context initialized");
                }
            } catch (error) {
                debugLog('Audio init warning: ' + error.message);
            }
        }

        // Game start
        function handleUserInteraction() {
            if (GameState.userInteracted) return;
            GameState.userInteracted = true;

            elements.startButton.style.display = 'none';
            updateStatus("Starting game...");

            // Setup
            initializeAudio();
            elements.canvas.width = 800;
            elements.canvas.height = 600;

            if (!window.pygame) {
                debugLog('Game start failed: pygame-web not loaded');
                showError('Game failed to start: pygame-web not loaded');
                GameState.userInteracted = false;
                elements.startButton.style.display = 'block';
                return;
            }

            // Install dependencies
            updateStatus("Installing dependencies...");
            
            var installPromise = Promise.resolve();
            try {
                installPromise = window.pygame.installPackages(['pygame-base']);
            } catch (installError) {
                debugLog('Dependency install warning: ' + installError.message);
            }
            
            installPromise.then(function() {
                return new Promise(function(resolve) {
                    setTimeout(resolve, 2000);
                });
            }).then(function() {
                // Load main game
                updateStatus("Loading game...");
                return window.pygame.import("./assets/main.py", {
                    argv: ['main.py'],
                    embed: true
                });
            }).then(function() {
                // Success
                GameState.gameStarted = true;
                elements.overlay.classList.add('hidden');
                setTimeout(function() {
                    elements.overlay.style.display = 'none';
                }, 500);
            }).catch(function(error) {
                debugLog('Game start failed: ' + error.message);
                showError('Game failed to start: ' + error.message);
                GameState.userInteracted = false;
                elements.startButton.style.display = 'block';
            });
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners
            elements.startButton.addEventListener('click', handleUserInteraction);
            elements.canvas.addEventListener('click', function() {
                if (GameState.pygameReady && !GameState.gameStarted) {
                    handleUserInteraction();
                }
            });

            // Load pygame
            loadPygameWeb().then(function(loaded) {
                if (!loaded) return;
                
                // Ready to start
                GameState.pygameReady = true;
                updateStatus("Ready to start! üéÆ");
                elements.startButton.style.display = 'block';
            });
        });

        // Global error handling
        window.addEventListener('error', function(event) {
            var errorMsg = event.error ? event.error.message : event.message;
            debugLog('Global error: ' + errorMsg);
            if (!GameState.gameStarted) {
                showError("Unexpected error occurred. Check debug info.");
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // Prevent zoom on mobile
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        // Make functions global
        window.showDebug = showDebug;
    </script>
</body>
</html>