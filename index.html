<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fun Run Game</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* (Behalte deine bestehenden CSS-Stile bei) */
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h1>üèÉ‚Äç‚ôÇÔ∏è FUN RUN</h1>
        <div class="loading-spinner"></div>
        <div id="status-message">Initializing pygame-web...</div>
        <button id="start-button" style="display: none;">üöÄ START GAME</button>
        <div id="error-message" style="display: none;"></div>
        <div id="debug-info" style="display: none;"></div>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        const GameState = {
            pygameReady: false,
            userInteracted: false,
            gameStarted: false,
            debug: []
        };

        const elements = {
            overlay: document.getElementById('loading-overlay'),
            canvas: document.getElementById('canvas'),
            startButton: document.getElementById('start-button'),
            statusMessage: document.getElementById('status-message'),
            errorMessage: document.getElementById('error-message'),
            debugInfo: document.getElementById('debug-info')
        };

        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            GameState.debug.push(logMessage);
            console.log(logMessage);
            
            if (GameState.debug.length > 20) {
                GameState.debug.shift();
            }
        }

        function updateStatus(message) {
            elements.statusMessage.textContent = message;
            debugLog(`Status: ${message}`);
        }

        function showDebug() {
            elements.debugInfo.textContent = GameState.debug.join('\n');
            elements.debugInfo.style.display = 'block';
        }

        function showError(message) {
            elements.errorMessage.innerHTML = `
                <div>${message}</div>
                <div style="margin-top: 10px; font-size: 12px;">
                    <button onclick="showDebug()">Show Debug Info</button>
                    <button onclick="location.reload()">Refresh Page</button>
                </div>
            `;
            elements.errorMessage.style.display = 'block';
            elements.startButton.style.display = 'none';
            debugLog(`Error: ${message}`);
        }

        async function loadPygameWeb() {
            try {
                updateStatus("Loading pygame-web...");
                debugLog("Starting pygame-web initialization");
                
                // Use newer version of pygame-web
                const script = document.createElement('script');
                script.src = 'https://pygame-web.github.io/archives/0.9/pythons.js';
                script.type = 'module';
                script.setAttribute('data-python', 'python3.11');
                script.setAttribute('data-os', 'vtx,fs,snd,gui');
                script.setAttribute('data-archive', 'true');
                
                debugLog("Pygame-web script created with attributes");
                
                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        debugLog("Pygame-web script loaded successfully");
                        resolve();
                    };
                    
                    script.onerror = (error) => {
                        debugLog(`Script loading failed: ${error}`);
                        reject(new Error('Failed to load pygame-web script'));
                    };
                    
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        reject(new Error('Timeout loading pygame-web script'));
                    }, 20000);
                });
                
                debugLog("Waiting for pygame to initialize...");
                updateStatus("Initializing pygame runtime...");
                
                return await new Promise((resolve) => {
                    let attempts = 0;
                    const maxAttempts = 100;
                    
                    const checkPygame = setInterval(() => {
                        attempts++;
                        
                        if (window.pygame && typeof window.pygame.import === 'function') {
                            clearInterval(checkPygame);
                            resolve(true);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkPygame);
                            resolve(false);
                        }
                        
                        if (attempts % 10 === 0) {
                            debugLog(`Pygame check attempt ${attempts}/${maxAttempts}`);
                            updateStatus(`Initializing pygame runtime... (${attempts/5}s)`);
                        }
                    }, 200);
                });
                
            } catch (error) {
                debugLog(`pygame-web loading failed: ${error.message}`);
                return false;
            }
        }

        function initializeAudio() {
            try {
                // Simplified audio context initialization
                if (window.AudioContext || window.webkitAudioContext) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    debugLog("Audio context initialized");
                }
            } catch (error) {
                debugLog(`Audio initialization failed: ${error.message}`);
            }
        }

        async function checkGameFile() {
            try {
                const response = await fetch('./assets/main.py');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return true;
            } catch (error) {
                debugLog(`Game file check failed: ${error.message}`);
                return false;
            }
        }

        async function handleUserInteraction() {
            if (GameState.userInteracted) return;
            GameState.userInteracted = true;

            elements.startButton.style.display = 'none';
            updateStatus("Starting game...");

            try {
                initializeAudio();
                elements.canvas.width = 800;
                elements.canvas.height = 600;

                if (!window.pygame) {
                    throw new Error("pygame-web not loaded");
                }

                updateStatus("Checking game files...");
                const gameFileExists = await checkGameFile();
                if (!gameFileExists) {
                    throw new Error("Game file 'assets/main.py' not found");
                }

                updateStatus("Loading game assets...");
                debugLog("Attempting to import main.py");
                
                // Add error handling for the import
                try {
                    await window.pygame.import("./assets/main.py");
                } catch (importError) {
                    throw new Error(`Failed to import game: ${importError.message}`);
                }
                
                GameState.gameStarted = true;
                updateStatus("Game started successfully!");
                debugLog("Game started successfully");

                setTimeout(() => {
                    elements.overlay.classList.add('hidden');
                    setTimeout(() => {
                        elements.overlay.style.display = 'none';
                    }, 500);
                }, 1000);

            } catch (error) {
                debugLog(`Game startup failed: ${error.message}`);
                showError(`Failed to start game: ${error.message}`);
                GameState.userInteracted = false;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            debugLog("DOM loaded, initializing...");
            
            elements.startButton.addEventListener('click', handleUserInteraction);
            elements.canvas.addEventListener('click', () => {
                if (GameState.pygameReady && !GameState.gameStarted) {
                    handleUserInteraction();
                }
            });

            const loaded = await loadPygameWeb();
            
            if (!loaded) {
                showError("Failed to initialize pygame-web. Please check your internet connection and try again.");
                return;
            }

            GameState.pygameReady = true;
            updateStatus("Ready to start! üéÆ");
            elements.startButton.style.display = 'block';
            debugLog("Initialization complete - ready to start game");
        });

        window.addEventListener('error', (event) => {
            debugLog(`Global error: ${event.error?.message || event.message}`);
            if (!GameState.gameStarted) {
                showError("An unexpected error occurred. Check the debug info for details.");
            }
        });

        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        });

        window.showDebug = showDebug;
    </script>
</body>
</html>