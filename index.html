<!DOCTYPE html>
<html lang="de">
<head>
    <title>Fun Run Game</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            overflow: hidden;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            margin: 0 auto;
            background: #000;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        #loading-overlay h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { 
                filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            }
            to { 
                filter: drop-shadow(0 0 20px rgba(255,255,255,0.6));
            }
        }
        
        #start-button {
            padding: 15px 30px;
            font-size: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        #start-button:active {
            transform: translateY(0);
        }
        
        #status-message {
            margin-top: 20px;
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            max-width: 80%;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #error-message {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }
        
        #debug-info {
            background: rgba(0,0,0,0.3);
            color: #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: left;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .error-button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .error-button:hover {
            background: #cc3333;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h1>üèÉ‚Äç‚ôÇÔ∏è FUN RUN</h1>
        <div class="loading-spinner"></div>
        <div id="status-message">Initializing pygame-web...</div>
        <button id="start-button" style="display: none;">üöÄ START GAME</button>
        <div id="error-message" style="display: none;"></div>
        <div id="debug-info" style="display: none;"></div>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        // Configuration with working pygame-web URLs
        var CONFIG = {
            PYGAME_SOURCES: [
                'https://cdn.jsdelivr.net/gh/pygame-web/pygame-web@0.9.0/dist/pygame.js',
                'https://unpkg.com/pygame-web@0.9.0/dist/pygame.js',
                'https://pygame-web.github.io/archives/0.9.0/pygame.js'
            ],
            PYTHON_VERSION: '3.11',
            LOAD_TIMEOUT: 60000
        };

        // Game state
        var GameState = {
            pygameReady: false,
            userInteracted: false,
            gameStarted: false,
            debug: []
        };

        // DOM elements
        var elements = {
            overlay: document.getElementById('loading-overlay'),
            canvas: document.getElementById('canvas'),
            startButton: document.getElementById('start-button'),
            statusMessage: document.getElementById('status-message'),
            errorMessage: document.getElementById('error-message'),
            debugInfo: document.getElementById('debug-info')
        };

        // Debug logging
        function debugLog(message) {
            var timestamp = new Date().toLocaleTimeString();
            var logMessage = '[' + timestamp + '] ' + message;
            GameState.debug.push(logMessage);
            console.log(logMessage);
            
            if (GameState.debug.length > 20) {
                GameState.debug.shift();
            }
        }

        function updateStatus(message) {
            elements.statusMessage.textContent = message;
            debugLog('Status: ' + message);
        }

        function showDebug() {
            elements.debugInfo.textContent = GameState.debug.join('\n');
            elements.debugInfo.style.display = 'block';
        }

        function showError(message) {
            var safeMessage = String(message).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            var errorHtml = '<div>' + safeMessage + '</div>';
            errorHtml += '<div style="margin-top: 10px; font-size: 12px;">';
            errorHtml += '<button class="error-button" onclick="window.showDebug()">Show Debug Info</button>';
            errorHtml += '<button class="error-button" onclick="location.reload()">Refresh Page</button>';
            errorHtml += '</div>';
            
            elements.errorMessage.innerHTML = errorHtml;
            elements.errorMessage.style.display = 'block';
            elements.startButton.style.display = 'none';
            debugLog('Error: ' + message);
        }

        // Pygame-web initialization with better error handling
        function loadPygameWeb() {
            return new Promise(function(resolve, reject) {
                var sourceIndex = 0;
                
                function tryNextSource() {
                    if (sourceIndex >= CONFIG.PYGAME_SOURCES.length) {
                        showError('Failed to load pygame-web from all sources. This may be due to:\n1. Network connectivity issues\n2. CORS restrictions\n3. Library unavailability\n\nTry using a different browser or check your network connection.');
                        resolve(false);
                        return;
                    }
                    
                    var source = CONFIG.PYGAME_SOURCES[sourceIndex];
                    
                    try {
                        updateStatus('Loading pygame-web from ' + new URL(source).hostname + '...');
                        debugLog('Trying source: ' + source);
                        
                        // Remove existing scripts
                        var existingScripts = document.querySelectorAll('script[src*="pygame"]');
                        existingScripts.forEach(function(script) {
                            script.remove();
                        });
                        
                        var script = document.createElement('script');
                        script.src = source;
                        script.type = 'text/javascript';
                        script.crossOrigin = 'anonymous';
                        
                        var timeout = setTimeout(function() {
                            debugLog('Timeout loading from ' + source);
                            script.remove();
                            sourceIndex++;
                            tryNextSource();
                        }, CONFIG.LOAD_TIMEOUT);
                        
                        script.onload = function() {
                            clearTimeout(timeout);
                            debugLog('Script loaded from ' + source);
                            
                            // Check for pygame availability
                            var checkInterval = setInterval(function() {
                                if (window.pygame || window.Pygame) {
                                    clearInterval(checkInterval);
                                    debugLog('pygame-web successfully initialized');
                                    resolve(true);
                                }
                            }, 100);
                            
                            // Fallback timeout
                            setTimeout(function() {
                                clearInterval(checkInterval);
                                if (!window.pygame && !window.Pygame) {
                                    debugLog('pygame-web not found after script load');
                                    sourceIndex++;
                                    tryNextSource();
                                }
                            }, 5000);
                        };
                        
                        script.onerror = function(error) {
                            clearTimeout(timeout);
                            debugLog('Failed to load from ' + source + ': ' + error.message);
                            script.remove();
                            sourceIndex++;
                            tryNextSource();
                        };
                        
                        document.head.appendChild(script);
                        
                    } catch (error) {
                        debugLog('Exception with source ' + source + ': ' + error.message);
                        sourceIndex++;
                        tryNextSource();
                    }
                }
                
                tryNextSource();
            });
        }

        // Alternative: Create a fallback game without pygame-web
        function createFallbackGame() {
            updateStatus("Creating fallback game...");
            
            var ctx = elements.canvas.getContext('2d');
            elements.canvas.width = 800;
            elements.canvas.height = 600;
            
            // Simple fallback game
            var game = {
                player: { x: 50, y: 300, width: 30, height: 30, velocityY: 0, onGround: false },
                obstacles: [],
                score: 0,
                gameSpeed: 2,
                keys: {},
                running: true
            };
            
            // Game loop
            function gameLoop() {
                if (!game.running) return;
                
                // Clear canvas
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, 800, 600);
                
                // Ground
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, 550, 800, 50);
                
                // Player physics
                if (game.keys['Space'] || game.keys['ArrowUp']) {
                    if (game.player.onGround) {
                        game.player.velocityY = -15;
                        game.player.onGround = false;
                    }
                }
                
                game.player.velocityY += 0.8; // gravity
                game.player.y += game.player.velocityY;
                
                // Ground collision
                if (game.player.y >= 520) {
                    game.player.y = 520;
                    game.player.velocityY = 0;
                    game.player.onGround = true;
                }
                
                // Draw player
                ctx.fillStyle = '#FF6B6B';
                ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
                
                // Generate obstacles
                if (Math.random() < 0.005) {
                    game.obstacles.push({ x: 800, y: 520, width: 20, height: 30 });
                }
                
                // Update and draw obstacles
                for (var i = game.obstacles.length - 1; i >= 0; i--) {
                    var obstacle = game.obstacles[i];
                    obstacle.x -= game.gameSpeed;
                    
                    if (obstacle.x < -obstacle.width) {
                        game.obstacles.splice(i, 1);
                        game.score += 10;
                    } else {
                        // Collision detection
                        if (game.player.x < obstacle.x + obstacle.width &&
                            game.player.x + game.player.width > obstacle.x &&
                            game.player.y < obstacle.y + obstacle.height &&
                            game.player.y + game.player.height > obstacle.y) {
                            game.running = false;
                            ctx.fillStyle = 'rgba(0,0,0,0.7)';
                            ctx.fillRect(0, 0, 800, 600);
                            ctx.fillStyle = 'white';
                            ctx.font = '48px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText('GAME OVER', 400, 250);
                            ctx.fillText('Score: ' + game.score, 400, 320);
                            ctx.font = '24px Arial';
                            ctx.fillText('Press R to restart', 400, 380);
                            return;
                        }
                        
                        // Draw obstacle
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                    }
                }
                
                // Draw score
                ctx.fillStyle = 'black';
                ctx.font = '24px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('Score: ' + game.score, 10, 30);
                
                // Increase speed
                game.gameSpeed += 0.001;
                
                requestAnimationFrame(gameLoop);
            }
            
            // Event handlers
            document.addEventListener('keydown', function(e) {
                game.keys[e.code] = true;
                if (e.code === 'KeyR' && !game.running) {
                    // Restart game
                    game.player = { x: 50, y: 300, width: 30, height: 30, velocityY: 0, onGround: false };
                    game.obstacles = [];
                    game.score = 0;
                    game.gameSpeed = 2;
                    game.running = true;
                    gameLoop();
                }
            });
            
            document.addEventListener('keyup', function(e) {
                game.keys[e.code] = false;
            });
            
            // Touch support
            elements.canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                game.keys['Space'] = true;
            });
            
            elements.canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                game.keys['Space'] = false;
            });
            
            // Start game
            GameState.gameStarted = true;
            elements.overlay.classList.add('hidden');
            setTimeout(function() {
                elements.overlay.style.display = 'none';
            }, 500);
            
            gameLoop();
        }

        // Game start handler
        function handleUserInteraction() {
            if (GameState.userInteracted) return;
            GameState.userInteracted = true;

            elements.startButton.style.display = 'none';
            
            // Try pygame-web first, fallback to simple game
            if (window.pygame || window.Pygame) {
                updateStatus("Starting pygame game...");
                // TODO: Implement pygame game loading
                setTimeout(function() {
                    updateStatus("Pygame not fully implemented, starting fallback game...");
                    createFallbackGame();
                }, 1000);
            } else {
                updateStatus("Starting fallback game...");
                createFallbackGame();
            }
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            elements.startButton.addEventListener('click', handleUserInteraction);
            
            elements.canvas.addEventListener('click', function() {
                if (!GameState.gameStarted) {
                    handleUserInteraction();
                }
            });

            // Try to load pygame-web, but don't fail if it doesn't work
            loadPygameWeb().then(function(loaded) {
                if (loaded) {
                    GameState.pygameReady = true;
                    updateStatus("pygame-web loaded! Ready to start! üéÆ");
                } else {
                    updateStatus("Fallback game ready! Ready to start! üéÆ");
                }
                elements.startButton.style.display = 'block';
            });
        });

        // Global error handling
        window.addEventListener('error', function(event) {
            var errorMsg = event.error ? event.error.message : event.message;
            debugLog('Global error: ' + errorMsg);
        });

        // Prevent context menu and zoom
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        });

        // Make functions global
        window.showDebug = showDebug;
    </script>
</body>
</html>