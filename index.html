<!DOCTYPE html>
<html lang="en">
<head>
    <title>Fun Run Game</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            overflow: hidden;
            touch-action: manipulation;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            margin: 0 auto;
            background: #000;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        #loading-overlay h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 10px rgba(255,255,255,0.3); }
            to { text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.6); }
        }
        
        #start-button {
            padding: 15px 30px;
            font-size: 20px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        #start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        #start-button:active {
            transform: translateY(0);
        }
        
        #status-message {
            margin-top: 20px;
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            max-width: 80%;
        }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #error-message {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }
        
        #debug-info {
            background: rgba(0,0,0,0.3);
            color: #ccc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            max-width: 80%;
            text-align: left;
            font-size: 12px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h1>üèÉ‚Äç‚ôÇÔ∏è FUN RUN</h1>
        <div class="loading-spinner"></div>
        <div id="status-message">Initializing pygame-web...</div>
        <button id="start-button" style="display: none;">üöÄ START GAME</button>
        <div id="error-message" style="display: none;"></div>
        <div id="debug-info" style="display: none;"></div>
    </div>
    
    <canvas id="canvas"></canvas>

    <script>
        // Konfiguration
        const CONFIG = {
            // Prim√§re GitHub-Quelle mit Fallbacks
            PYGAME_SOURCES: [
                'https://pygame-web.github.io/archives/0.21/pythons.js',
                'https://raw.githack.com/pygame-web/pygame-web/0.21/pythons.js',
                'https://cdn.jsdelivr.net/gh/pygame-web/pygame-web@0.21/pythons.js'
            ],
            PYTHON_VERSION: 'python3.11',
            REPO_URL: 'https://pygame-web.github.io/repo/',
            LOAD_TIMEOUT: 45000 // 45 Sekunden
        };

        // Zustandsmanagement
        const GameState = {
            pygameReady: false,
            userInteracted: false,
            gameStarted: false,
            debug: []
        };

        // DOM Elemente
        const elements = {
            overlay: document.getElementById('loading-overlay'),
            canvas: document.getElementById('canvas'),
            startButton: document.getElementById('start-button'),
            statusMessage: document.getElementById('status-message'),
            errorMessage: document.getElementById('error-message'),
            debugInfo: document.getElementById('debug-info')
        };

        // Debug-Logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            GameState.debug.push(logMessage);
            console.log(logMessage);
            
            if (GameState.debug.length > 20) {
                GameState.debug.shift();
            }
        }

        function updateStatus(message) {
            elements.statusMessage.textContent = message;
            debugLog(`Status: ${message}`);
        }

        function showDebug() {
            elements.debugInfo.textContent = GameState.debug.join('\n');
            elements.debugInfo.style.display = 'block';
        }

        function showError(message) {
            elements.errorMessage.innerHTML = `
                <div>${message}</div>
                <div style="margin-top: 10px; font-size: 12px;">
                    <button onclick="showDebug()">Show Debug Info</button>
                    <button onclick="location.reload()">Refresh Page</button>
                </div>
            `;
            elements.errorMessage.style.display = 'block';
            elements.startButton.style.display = 'none';
            debugLog(`Error: ${message}`);
        }

        // Pygame-web Initialisierung
        async function loadPygameWeb() {
            // L√∂sche vorhandene Skripte
            document.querySelectorAll('script[src*="pythons.js"]').forEach(s => s.remove());
            
            for (const source of CONFIG.PYGAME_SOURCES) {
                try {
                    updateStatus(`Loading from ${new URL(source).hostname}...`);
                    debugLog(`Trying source: ${source}`);
                    
                    const script = document.createElement('script');
                    script.src = source;
                    script.type = 'module';
                    script.setAttribute('data-python', CONFIG.PYTHON_VERSION);
                    script.setAttribute('data-os', 'vtx,fs,snd,gui');
                    script.setAttribute('data-repo', CONFIG.REPO_URL);
                    
                    // Manuelle Konfiguration
                    script.onload = () => {
                        window.pygameConfig = {
                            stdio: 'inherit',
                            python: CONFIG.PYTHON_VERSION,
                            env: { PYTHONPATH: '/lib/python3.11' }
                        };
                    };

                    await new Promise((resolve, reject) => {
                        script.onerror = () => reject(new Error(`Failed to load from ${source}`));
                        document.head.appendChild(script);
                        
                        // Pr√ºfe auf Initialisierung
                        const check = setInterval(() => {
                            if (window.pygame && typeof window.pygame.import === 'function') {
                                clearInterval(check);
                                resolve();
                            }
                        }, 500);
                        
                        setTimeout(() => {
                            clearInterval(check);
                            reject(new Error(`Timeout loading from ${source}`));
                        }, CONFIG.LOAD_TIMEOUT);
                    });
                    
                    debugLog(`Successfully loaded from ${source}`);
                    return true;
                    
                } catch (error) {
                    debugLog(`Failed with source ${source}: ${error.message}`);
                    // L√∂sche fehlgeschlagenes Skript
                    document.querySelectorAll(`script[src="${source}"]`).forEach(s => s.remove());
                }
            }
            
            showError(`
                Failed to load pygame-web from all sources.<br>
                Please try:<br>
                1. Refreshing the page<br>
                2. Using Chrome/Edge browser<br>
                3. Checking your network connection
            `);
            return false;
        }

        // Audio-Initialisierung
        function initializeAudio() {
            try {
                if (window.AudioContext || window.webkitAudioContext) {
                    new (window.AudioContext || window.webkitAudioContext)();
                    debugLog("Audio context initialized");
                }
            } catch (error) {
                debugLog(`Audio init warning: ${error.message}`);
            }
        }

        // Spielstart
        async function handleUserInteraction() {
            if (GameState.userInteracted) return;
            GameState.userInteracted = true;

            elements.startButton.style.display = 'none';
            updateStatus("Starting game...");

            try {
                // Vorbereitungen
                initializeAudio();
                elements.canvas.width = 800;
                elements.canvas.height = 600;

                if (!window.pygame) {
                    throw new Error("pygame-web not loaded");
                }

                // Abh√§ngigkeiten installieren
                updateStatus("Installing dependencies...");
                try {
                    await window.pygame.installPackages(['pygame-base']);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                } catch (installError) {
                    debugLog(`Dependency install warning: ${installError.message}`);
                }

                // Hauptspiel laden
                updateStatus("Loading game...");
                await window.pygame.import("./assets/main.py", {
                    argv: ['main.py'],
                    embed: true
                });
                
                // Erfolg
                GameState.gameStarted = true;
                elements.overlay.classList.add('hidden');
                setTimeout(() => elements.overlay.style.display = 'none', 500);

            } catch (error) {
                debugLog(`Game start failed: ${error.message}`);
                showError(`Game failed to start: ${error.message}`);
                GameState.userInteracted = false;
                elements.startButton.style.display = 'block';
            }
        }

        // Hauptinitialisierung
        document.addEventListener('DOMContentLoaded', async () => {
            // Event Listener
            elements.startButton.addEventListener('click', handleUserInteraction);
            elements.canvas.addEventListener('click', () => {
                if (GameState.pygameReady && !GameState.gameStarted) {
                    handleUserInteraction();
                }
            });

            // Pygame laden
            const loaded = await loadPygameWeb();
            if (!loaded) return;

            // Erfolg
            GameState.pygameReady = true;
            updateStatus("Ready to start! üéÆ");
            elements.startButton.style.display = 'block';
        });

        // Globale Fehlerbehandlung
        window.addEventListener('error', (event) => {
            debugLog(`Global error: ${event.error?.message || event.message}`);
            if (!GameState.gameStarted) {
                showError("Unexpected error occurred. Check debug info.");
            }
        });

        // Hilfsfunktionen
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        });

        window.showDebug = showDebug;
    </script>
</body>
</html>